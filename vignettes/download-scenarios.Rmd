---
title: "download-scenarios"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{download-scenarios}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(trisk.analysis)
library(dplyr)
library(fs)
```


# Download the data




Data will be downloaded from this endpoint:
```{r}
print(
paste0(trisk.analysis:::TRISK_DATA_INPUT_ENDPOINT, "/", trisk.analysis:::TRISK_DATA_S3_PREFIX)
)
```


Choose the folder where to download the data
```{r}
trisk_inputs_folder <- file.path(".", "trisk_inputs")
```

Download the data using the provided function
```{r}
download_success <- download_trisk_inputs(local_save_folder = trisk_inputs_folder)
```

The previous function downloads those 4 files : 
```{r echo=FALSE}
dir_tree(trisk_inputs_folder)
```


# Descriptive statistics

Load the downloaded scenario data
```{r}
if (download_success) {
  scenarios <- read.csv(file.path(trisk_inputs_folder, "scenarios.csv"))
}
```


## Sectors covered by scenarios 


```{r}
if (download_success) {
  scenarios <- read.csv(file.path(trisk_inputs_folder, "scenarios.csv"))
  number_of_scenario_per_sector <- scenarios %>%
    distinct(scenario, sector, technology) %>%
    group_by(sector, technology) %>%
    summarise(n_scenarios = n())
}
```

```{r echo=FALSE}
if (download_success) {
  knitr::kable(number_of_scenario_per_sector) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "400px")
}
```


```{r}
if (download_success) {
  sectors_covered_by_scenarios <- scenarios %>%
    distinct(sector, scenario) %>%
    arrange(sector, scenario)
}
```



```{r echo=FALSE}
if (download_success) {
  knitr::kable(sectors_covered_by_scenarios) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "400px")
}
```


## Available parameters

```{r}
if (download_success) {
  available_parameters <- get_available_parameters(scenarios)
}
```


```{r echo=FALSE}
if (download_success) {
  knitr::kable(available_parameters) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "400px")
}
```

# Run Trisk on a geography

When choosing a geography different than "Global", the input assets dataframe is filtered on the geography's countries, and the scenarios is filtered to use the pathways defined in this geography. This means that only the assets located in the countries covered by this geography will be considered for analysis, on geography-specific pathways.

```{r}
if (download_success) {
  assets_data <- read.csv(file.path(trisk_inputs_folder, "assets.csv"))
  scenarios_data <-read.csv(file.path(trisk_inputs_folder, "scenarios.csv"))
  financial_features_data <- read.csv(file.path(trisk_inputs_folder, "financial_features.csv"))
  ngfs_carbon_price_data <- read.csv(file.path(trisk_inputs_folder, "ngfs_carbon_price.csv"))
}
```

```{r}
baseline_scenario <- "NGFS2023GCAM_CP"
target_scenario <- "NGFS2023GCAM_NZ2050"
scenario_geography <- "OecdAndEu" # CHANGE GEOGRAPHY
```

```{r}
if (download_success) {
  st_results <- run_trisk_model(
    assets_data = assets_data,
    scenarios_data = scenarios_data,
    financial_data = financial_features_data,
    carbon_data = ngfs_carbon_price_data,
    baseline_scenario = baseline_scenario,
    target_scenario = target_scenario,
    scenario_geography = scenario_geography
  )
}
```


```{r echo=FALSE}
if (download_success) {
  knitr::kable(st_results$npv_results) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "400px")
}
```

# Run Trisk with carbon tax


```{r}
if (download_success) {
  available_carbon_taxes <- ngfs_carbon_price_data %>%
    distinct(model)
  print(available_carbon_taxes)
}
```

It is then possible to choose a carbon tax and a passthrough, to adjust its impact on NPV:
```{r}
carbon_price_model <- "GCAM 5.3+ NGFS"
market_passthrough <- 0.3
```


```{r}
if (download_success) {
  st_results <- run_trisk_model(
    assets_data = assets_data,
    scenarios_data = scenarios_data,
    financial_data = financial_features_data,
    carbon_data = ngfs_carbon_price_data,
    baseline_scenario = baseline_scenario,
    target_scenario = target_scenario,
    scenario_geography = scenario_geography,
    carbon_price_model=carbon_price_model,
    market_passthrough=market_passthrough
  )
}
```
